<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="en">
<head>
    <title>Change Request</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <meta charset="UTF-8">
</head>
<body>
<div class="container">
    <div class="logout-form" sec:authorize="isAuthenticated()">
        <form th:action="@{/logout}" method="post">
            <button type="submit">Logout</button>
        </form>
    </div>
    <aside class="sidebar pretty" id="appSidebar">
        <!-- Brand / collapse -->
        <a class="sb-link" th:href="@{/dashboard}"
           th:classappend="${page}=='dashboard' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M3 11l9-7 9 7v8" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Dashboard</span>
        </a>

        <a class="sb-link" th:href="@{/tasks}" sec:authorize="hasRole('USER')"
           th:classappend="${page}=='tasks' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h10" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Tasks</span>
        </a>

        <a class="sb-link" th:href="@{/tasks/team}" sec:authorize="hasRole('IT_TEAM')"
           th:classappend="${page}=='tasks-team' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Team Tasks</span>
        </a>

        <a class="sb-link" th:href="@{/tasks/manager}" sec:authorize="hasRole('IT_MANAGER')"
           th:classappend="${page}=='tasks-manager' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M12 6a3 3 0 1 1 3 3" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Manager Tasks</span>
        </a>
        <a class="sb-link" th:href="@{/tasks/director}" sec:authorize="hasRole('IT_DIRECTOR')"
           th:classappend="${page}=='tasks-director' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M12 6a3 3 0 1 1 3 3" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>All Tasks</span>
        </a>
        <a class="sb-link" th:href="@{/change-requests}"
           th:classappend="${page}=='changes' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M4 4h10v6H4M4 14h16v6H4" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Change Requests</span>
        </a>

        <a class="sb-link" th:href="@{/users}"
           th:classappend="${page}=='users' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M8 11a4 4 0 1 0-4-4" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Users</span>
        </a>

        <a class="sb-link" th:href="@{/profile}"
           th:classappend="${page}=='profile' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Profile</span>
        </a>
    </aside>

    <div class="main-content">
        <header>
            <h1 th:text="${changeRequest.title}">Change Request</h1>
            <div class="muted">Status:
                <strong th:text="${changeRequest.status}">DRAFT</strong>
            </div>
        </header>

        <!-- flash -->
        <div th:if="${message}" class="alert success" th:text="${message}"></div>
        <div th:if="${error}" class="alert error" th:text="${error}"></div>

        <div class="details-card">
            <p><strong>Description:</strong></p>
            <p th:text="${changeRequest.description}">No data</p>

            <div class="grid-2">
                <div>
                    <p><strong>Impact Analysis</strong></p>
                    <p th:text="${changeRequest.impactAnalysis}">No data</p>
                </div>
                <div>
                    <p><strong>Risk</strong></p>
                    <p th:text="${changeRequest.risk}">No data</p>
                </div>
            </div>

            <div class="grid-2">
                <div>
                    <p><strong>Affected Item</strong></p>
                    <p th:text="${changeRequest.affectedItem}">No data</p>
                </div>
                <div>
                    <p><strong>Change Reason</strong></p>
                    <p th:text="${changeRequest.changeReason}">No data</p>
                </div>
            </div>

            <div class="grid-2">
                <div>
                    <p><strong>Backout Plan</strong></p>
                    <p th:text="${changeRequest.backoutPlan}">No data</p>
                </div>
                <div>
                    <p><strong>Verification Plan</strong></p>
                    <p th:text="${changeRequest.verificationPlan}">No data</p>
                </div>
            </div>

            <p><strong>Related Task:</strong>
                <span th:if="${changeRequest.task == null}">No data</span>
                <a th:if="${changeRequest.task != null}"
                   th:href="@{/tasks/{id}(id=${changeRequest.task.id})}"
                   th:text="${changeRequest.task.title}">Task</a>
            </p>

            <p><strong>Submitted by:</strong>
                <span
                        th:text="${changeRequest.submittedBy != null ? changeRequest.submittedBy.firstName + ' ' + changeRequest.submittedBy.lastName : '—'}">No data</span>
                <span th:if="${changeRequest.submittedAt != null}"> •
    <em th:text="${#temporals.format(changeRequest.submittedAt, 'yyyy-MM-dd HH:mm')}"></em>
  </span>
            </p>

            <p><strong>Decision:</strong>
                <span th:text="${changeRequest.reviewComment != null ? changeRequest.reviewComment : 'No data'}">No
                    data</span>
                <span th:if="${changeRequest.reviewedBy != null}"> by
    <em th:text="${changeRequest.reviewedBy.firstName + ' ' + changeRequest.reviewedBy.lastName}"></em>
  </span>
                <span th:if="${changeRequest.reviewedAt != null}">
    <em th:text="${#temporals.format(changeRequest.reviewedAt, 'yyyy-MM-dd HH:mm')}"></em>
  </span>
            </p>

            <div class="action-buttons">
                <a th:href="@{/change-requests}" class="btn btn-secondary">Back</a>
                <!-- Submit button only if DRAFT -->
                <form th:if="${changeRequest.status.name() == 'DRAFT'}"
                      th:action="@{/change-requests/{id}/submit(id=${changeRequest.id})}"
                      method="post" style="display:inline-block"
                      sec:authorize="hasAnyRole('IT_TEAM','IT_MANAGER')">
                    <button type="submit" class="btn">Submit for review</button>
                </form>

                <!-- Director review entry -->
                <a th:if="${changeRequest.status.name() == 'UNDER_REVIEW'}"
                   th:href="@{/change-requests/{id}/review(id=${changeRequest.id})}"
                   class="btn" sec:authorize="hasRole('IT_DIRECTOR')">Review</a>

                <a th:href="@{/change-requests/edit/{id}(id=${changeRequest.id})}"
                   class="btn"
                   sec:authorize="hasAnyRole('IT_TEAM','IT_MANAGER')">Edit</a>
            </div>
        </div>
    </div>
</div>
</body>
</html>
