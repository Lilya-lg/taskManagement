<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Task</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <meta charset="UTF-8">
</head>
<body>
<div class="container">
    <div class="logout-form" sec:authorize="isAuthenticated()">
        <form th:action="@{/logout}" method="post">
            <button type="submit">Logout</button>
        </form>
    </div>
    <!-- Sidebar -->
    <aside class="sidebar pretty" id="appSidebar">
        <!-- Brand / collapse -->
        <a class="sb-link" th:href="@{/dashboard}"
           th:classappend="${page}=='dashboard' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M3 11l9-7 9 7v8" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Dashboard</span>
        </a>

        <a class="sb-link" th:href="@{/tasks}" sec:authorize="hasRole('USER')"
           th:classappend="${page}=='tasks' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h10" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Tasks</span>
        </a>

        <a class="sb-link" th:href="@{/tasks/team}" sec:authorize="hasRole('IT_TEAM')"
           th:classappend="${page}=='tasks-team' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Team Tasks</span>
        </a>

        <a class="sb-link" th:href="@{/tasks/manager}" sec:authorize="hasRole('IT_MANAGER')"
           th:classappend="${page}=='tasks-manager' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M12 6a3 3 0 1 1 3 3" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Manager Tasks</span>
        </a>
        <a class="sb-link" th:href="@{/tasks/director}" sec:authorize="hasRole('IT_DIRECTOR')"
           th:classappend="${page}=='tasks-director' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M12 6a3 3 0 1 1 3 3" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>All Tasks</span>
        </a>
        <a class="sb-link" th:href="@{/change-requests}"
           th:classappend="${page}=='changes' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M4 4h10v6H4M4 14h16v6H4" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Change Requests</span>
        </a>

        <a class="sb-link" th:href="@{/users}"
           th:classappend="${page}=='users' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M8 11a4 4 0 1 0-4-4" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Users</span>
        </a>

        <a class="sb-link" th:href="@{/profile}"
           th:classappend="${page}=='profile' ? ' active' : ''">
            <svg class="i" viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            <span>Profile</span>
        </a>
    </aside>
    <!-- Main content -->
    <div class="main-content">
        <header>
            <h1>Edit Task</h1>
            <p>Update the details of your task below.</p>
        </header>

        <!-- Form container styled as a card -->
        <div class="form-card">
            <form th:action="@{/tasks/edit/{id}(id=${task.id})}" method="post" th:object="${task}" enctype="multipart/form-data">

                <!-- Task Title -->
                <div class="form-row">
                    <label for="titleEditable">Title:</label>

                    <!-- Editable if status is TODO or user is not a USER -->
                    <th:block th:if="${task.status == 'TODO' or !(#authentication.authorities.?[authority == 'ROLE_USER'].size() > 0)}">
                        <input type="text" id="titleEditable" th:field="*{title}" placeholder="Task Title"/>
                    </th:block>

                    <!-- Read-only otherwise -->
                    <th:block th:unless="${task.status == 'TODO' or !(#authentication.authorities.?[authority == 'ROLE_USER'].size() > 0)}">
                        <input type="text" id="titleReadonly" th:field="*{title}" placeholder="Task Title" readonly/>
                    </th:block>
                    <span th:if="${#fields.hasErrors('title')}" th:errors="*{title}">Error</span>
                </div>

                <!-- Task Description -->
                <div class="form-row">
                    <label for="descriptionEditable">Description:</label>

                    <!-- Editable if status is TODO or user is not a USER -->
                    <th:block th:if="${task.status == 'TODO' or !(#authentication.authorities.?[authority == 'ROLE_USER'].size() > 0)}">
                        <textarea id="descriptionEditable" th:field="*{description}" rows="4" placeholder="Task Description"></textarea>
                    </th:block>

                    <!-- Read-only if status is not TODO and user is a USER -->
                    <th:block th:unless="${task.status == 'TODO' or !(#authentication.authorities.?[authority == 'ROLE_USER'].size() > 0)}">
                        <textarea id="descriptionReadonly" th:field="*{description}" rows="4" placeholder="Task Description" readonly></textarea>
                    </th:block>

                    <span th:if="${#fields.hasErrors('description')}" th:errors="*{description}">Error</span>
                </div>

                <!-- Task Status -->
                <div class="form-row">
                    <label for="statusEditable">Status:</label>

                    <!-- Editable for Non-USER Roles -->
                    <th:block sec:authorize="!hasRole('USER')">
                        <select id="statusEditable" th:field="*{status}">
                            <option value="TODO">TODO</option>
                            <option value="IN_PROGRESS">In Progress</option>
                            <option value="COMPLETED">Completed</option>
                        </select>
                    </th:block>

                    <!-- Read-only for USER Role -->
                    <th:block sec:authorize="hasRole('USER')">
                        <select id="statusReadonly" th:field="*{status}" disabled>
                            <option value="TODO">TODO</option>
                            <option value="IN_PROGRESS">In Progress</option>
                            <option value="COMPLETED">Completed</option>
                        </select>
                        <input type="hidden" th:field="*{status}"/>
                    </th:block>

                    <span th:if="${#fields.hasErrors('status')}" th:errors="*{status}">Error</span>
                </div>

                <div class="form-row">
                    <label for="dueDateEditable">Due Date:</label>

                    <!-- Editable for Non-USER Roles -->
                    <th:block sec:authorize="!hasRole('USER')">
                        <input type="date" id="dueDateEditable" th:field="*{dueDate}" />
                    </th:block>

                    <!-- Read-only for USER Role -->
                    <th:block sec:authorize="hasRole('USER')">
                        <input type="date" id="dueDateReadonly" th:field="*{dueDate}" readonly />
                    </th:block>

                    <span th:if="${#fields.hasErrors('dueDate')}" th:errors="*{dueDate}">Error</span>
                </div>

                <div class="form-row">
                    <label for="priority">Priority:</label>
                    <select id="priority" th:field="*{priority}">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="requestType">Request Type:</label>
                    <select id="requestType" th:field="*{requestType}">
                        <option value="INFRA">INFRA</option>
                        <option value="PROD_APPS">Prod Apps</option>
                        <option value="BUSINESS_APPS">Business Apps</option>
                    </select>
                </div>
                <!-- Assigned User (ensure selected user is pre-populated) -->
                <div class="form-row">
                    <label for="assignedUserEditable">Assigned User:</label>

                    <!-- Editable for Non-USER Roles -->
                    <th:block sec:authorize="!hasRole('USER')">
                        <select id="assignedUserEditable" th:field="*{assignedUser}">
                            <option th:each="user : ${users}"
                                    th:value="${user.id}"
                                    th:text="${user.firstName + ' ' + user.lastName}"
                                    th:selected="${assignedUser != null and user.id == assignedUser.id}">
                                User
                            </option>
                        </select>
                    </th:block>

                    <!-- Read-only for USER Role -->
                    <th:block sec:authorize="hasRole('USER')">
                        <select id="assignedUserReadonly" th:field="*{assignedUser}" disabled>
                            <option th:each="user : ${users}"
                                    th:value="${user.id}"
                                    th:text="${user.firstName + ' ' + user.lastName}"
                                    th:selected="${assignedUser != null and user.id == assignedUser.id}">
                                User
                            </option>
                        </select>
                    </th:block>

                    <span th:if="${#fields.hasErrors('assignedUser')}" th:errors="*{assignedUser}">Error</span>
                </div>
                <div class="form-row">
                    <label for="file">Upload File:</label>
                    <input type="file" id="file" name="file" />
                </div>
                <!-- Submit button -->
                <div class="action-buttons">
                    <button type="submit" class="btn">Save Changes</button>
                    <a th:href="@{/tasks}" class="btn btn-secondary" sec:authorize="hasRole('USER')">Back to Tasks</a>
                    <a th:href="@{/tasks/manager}" class="btn btn-secondary" sec:authorize="hasRole('IT_MANAGER')">Back to Tasks</a>
                    <a th:href="@{/tasks/team}" class="btn btn-secondary" sec:authorize="hasRole('IT_TEAM')">Back to Tasks</a>
                    <a th:href="@{/tasks}" class="btn btn-secondary" sec:authorize="hasRole('IT_DIRECTOR')">Back to Tasks</a>
                </div>
                <div class="form-row" th:if="${task.needApproval} and ${task.status != 'COMPLETED'}">
                    <button type="submit" class="btn btn-primary"
                            th:action="@{/tasks/send-for-approval/{id}(id=${task.id})}"
                            sec:authorize="hasRole('IT_TEAM')">
                        Send for Approval
                    </button>
                </div>
            </form>
        </div>
        <div id="comments" class="form-card">
            <h3>Progress comments</h3>

            <!-- Existing comments -->
            <div th:if="${#lists.isEmpty(comments)}" class="muted">No comments yet.</div>
            <ul th:if="${!#lists.isEmpty(comments)}" class="comment-list">
                <li th:each="c : ${comments}" class="comment-item">
                    <div class="comment-meta">
                <span class="comment-author"
                      th:text="${c.author != null ? c.author.firstName + ' ' + c.author.lastName : 'User'}">Author</span>
                        <span class="comment-date"
                              th:text="${#temporals.format(c.createdAt, 'yyyy-MM-dd HH:mm')}">2025-08-14 12:34</span>
                    </div>
                    <div class="comment-body" th:text="${c.body}">Comment text</div>

                    <div class="comment-progress" th:if="${c.progressPercent != null}">
                        Progress: <strong th:text="${c.progressPercent}">60</strong>%
                        <div class="progress-bar">
                            <div class="progress-fill" th:style="'width:' + ${c.progressPercent} + '%'"></div>
                        </div>
                    </div>
                </li>
            </ul>

            <!-- Add new comment -->
            <h4>Add a comment</h4>
            <form th:action="@{/task_details/{id}/comments(id=${task.id})}" method="post" th:object="${newComment}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="form-row">
                    <label for="body">Comment</label>
                    <textarea id="body" th:field="*{body}" rows="4" required
                              placeholder="What changed since last update?"></textarea>
                </div>
                <div class="form-row">
                    <label for="progressPercent">Progress % (optional)</label>
                    <input id="progressPercent" th:field="*{progressPercent}" type="number" min="0" max="100"
                           placeholder="e.g., 60"/>
                </div>
                <button type="submit" class="btn">Post comment</button>
            </form>
        </div>
    </div>
</div>
</body>
<script>
  (function(){
    const sb = document.getElementById('appSidebar');
    const btn = document.getElementById('sidebarToggle');

    // Persist state across navigations (optional)
    const key = 'sidebar.collapsed';
    if (localStorage.getItem(key) === '1') sb.classList.add('is-collapsed');

    btn?.addEventListener('click', function(){
      sb.classList.toggle('is-collapsed');
      localStorage.setItem(key, sb.classList.contains('is-collapsed') ? '1' : '0');
    });

    // On small screens you might prefer hiding instead of collapsing:
    // toggle 'is-hidden' class instead if you like.
  })();
</script>
</html>
