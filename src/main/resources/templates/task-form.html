<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
  <title>Create Task</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}">
  <meta charset="UTF-8">
</head>
<body>
<div class="container">
  <div class="logout-form" sec:authorize="isAuthenticated()">
    <form th:action="@{/logout}" method="post">
      <button type="submit">Logout</button>
    </form>
  </div>
  <aside class="sidebar pretty" id="appSidebar">
    <!-- Brand / collapse -->
    <a class="sb-link" th:href="@{/dashboard}"
       th:classappend="${page}=='dashboard' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M3 11l9-7 9 7v8" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Dashboard</span>
    </a>

    <a class="sb-link" th:href="@{/tasks}" sec:authorize="hasRole('USER')"
       th:classappend="${page}=='tasks' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h10" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Tasks</span>
    </a>

    <a class="sb-link" th:href="@{/tasks/team}" sec:authorize="hasRole('IT_TEAM')"
       th:classappend="${page}=='tasks-team' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Team Tasks</span>
    </a>

    <a class="sb-link" th:href="@{/tasks/manager}" sec:authorize="hasRole('IT_MANAGER')"
       th:classappend="${page}=='tasks-manager' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M12 6a3 3 0 1 1 3 3" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Manager Tasks</span>
    </a>
    <a class="sb-link" th:href="@{/tasks/director}" sec:authorize="hasRole('IT_DIRECTOR')"
       th:classappend="${page}=='tasks-director' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M12 6a3 3 0 1 1 3 3" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>All Tasks</span>
    </a>
    <a class="sb-link" th:href="@{/change-requests}"
       th:classappend="${page}=='changes' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M4 4h10v6H4M4 14h16v6H4" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Change Requests</span>
    </a>

    <a class="sb-link" th:href="@{/users}"
       th:classappend="${page}=='users' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M8 11a4 4 0 1 0-4-4" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Users</span>
    </a>

    <a class="sb-link" th:href="@{/profile}"
       th:classappend="${page}=='profile' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Profile</span>
    </a>
  </aside>

  <div class="main-content">
    <header>
      <h1>Create New Task</h1>
    </header>

    <!-- Task form container -->
    <div class="form-container">
      <form th:action="@{/tasks/new}" method="post" th:object="${task}" enctype="multipart/form-data">
        <!-- Task Title -->
        <div class="form-row">
          <label for="title">Title:</label>
          <input type="text" id="title" th:field="*{title}" />
          <span th:if="${#fields.hasErrors('title')}" th:errors="*{title}">Error</span>
        </div>

        <!-- Task Description -->
        <div class="form-row">
          <label for="description">Description:</label>
          <textarea id="description" th:field="*{description}" rows="4"></textarea>
          <span th:if="${#fields.hasErrors('description')}" th:errors="*{description}">Error</span>
        </div>

        <!-- Task Status -->
        <div class="form-row">
          <label for="status">Status:</label>

          <!-- Dropdown for Status -->
          <select id="status" th:field="*{status}"
                  th:disabled="${#authentication.principal.authorities.?[authority == 'ROLE_USER'].size() > 0}">
            <option value="TODO">TODO</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="COMPLETED">Completed</option>
          </select>

          <!-- Hidden field to ensure status is submitted -->
          <input type="hidden" th:value="${status}" th:field="*{status}" />

          <span th:if="${#fields.hasErrors('status')}" th:errors="*{status}">Error</span>
        </div>

        <!-- Task Due Date -->
        <div class="form-row" sec:authorize="!hasRole('USER')">
          <label for="dueDate">Due Date:</label>
          <input type="date" id="dueDate" th:field="*{dueDate}"
                 th:value="${#dates.format(dueDate, 'yyyy-MM-dd')}" />
          <span th:if="${#fields.hasErrors('dueDate')}" th:errors="*{dueDate}">Error</span>
        </div>
        <div class="form-row">
          <label for="requestType">Request Type:</label>
          <select id="requestType" th:field="*{requestType}">
            <option value="INFRA">INFRA</option>
            <option value="PROD_APPS">Prod Apps</option>
            <option value="BUSINESS_APPS">Business Apps</option>
          </select>
        </div>

        <div class="form-row">
          <label for="priority">Priority:</label>
          <select id="priority" th:field="*{priority}"
                  th:disabled="${#authorization.expression('!hasAnyRole(''IT_TEAM'',''IT_MANAGER'',''IT_DIRECTOR'',''ADMIN'')')}">
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
          </select>
        </div>

        <!-- Assigned User -->
        <div class="form-row" sec:authorize="hasAnyRole('IT_TEAM', 'IT_MANAGER', 'IT_DIRECTOR', 'ADMIN')">
          <label for="assignedUser">Assigned User:</label>
          <select id="assignedUser" th:field="*{assignedUser.id}">
            <!-- Default option for no user assigned -->
            <option value="" th:if="${assignedUser == null}">No User Assigned</option>
            <!-- Iterate over the users list and populate the dropdown -->
            <option th:each="user : ${users}" th:value="${user.id}"
                    th:text="${user.firstName + ' ' + user.lastName}"
                    th:selected="${assignedUser != null and user.id == assignedUser.id}">User</option>
          </select>
          <span th:if="${#fields.hasErrors('assignedUser')}" th:errors="*{assignedUser}">Error</span>
        </div>



        <!-- Requester (Read-Only) -->
        <div class="form-row">
          <label for="requester">Requester:</label>
          <input type="text" id="requester"
                 th:field="*{requester.firstName}"
                 th:readonly="true"
                 placeholder="Requester First Name" />
          <span th:if="${#fields.hasErrors('requester')}" th:errors="*{requester}">Error</span>
        </div>

        <div class="form-row">
          <label for="file">Upload File:</label>
          <input type="file" id="file" name="file" />
        </div>

        <!-- Submit button -->
        <div class="form-row">
          <button type="submit">Create Task</button>
        </div>
      </form>
    </div>
  </div>
</div>
</body>
<script>
  (function(){
    const sb = document.getElementById('appSidebar');
    const btn = document.getElementById('sidebarToggle');

    // Persist state across navigations (optional)
    const key = 'sidebar.collapsed';
    if (localStorage.getItem(key) === '1') sb.classList.add('is-collapsed');

    btn?.addEventListener('click', function(){
      sb.classList.toggle('is-collapsed');
      localStorage.setItem(key, sb.classList.contains('is-collapsed') ? '1' : '0');
    });

    // On small screens you might prefer hiding instead of collapsing:
    // toggle 'is-hidden' class instead if you like.
  })();
</script>

</html>
