<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
  <title>Task List</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}">
  <meta charset="UTF-8">
</head>
<script>
  // Auto-dismiss alerts after 6s
  setTimeout(() => {
    document.querySelectorAll('.alert').forEach(a => a.remove());
  }, 6000);
</script>
<body>
<div class="container">
  <div class="logout-form" sec:authorize="isAuthenticated()">
    <form th:action="@{/logout}" method="post">
      <button type="submit">Logout</button>
    </form>
  </div>
  <aside class="sidebar pretty" id="appSidebar">
    <!-- Brand / collapse -->
    <a class="sb-link" th:href="@{/dashboard}"
       th:classappend="${page}=='dashboard' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M3 11l9-7 9 7v8" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Dashboard</span>
    </a>

    <a class="sb-link" th:href="@{/tasks}" sec:authorize="hasRole('USER')"
       th:classappend="${page}=='tasks' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h10" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Tasks</span>
    </a>

    <a class="sb-link" th:href="@{/tasks/team}" sec:authorize="hasRole('IT_TEAM')"
       th:classappend="${page}=='tasks-team' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Team Tasks</span>
    </a>

    <a class="sb-link" th:href="@{/tasks/manager}" sec:authorize="hasRole('IT_MANAGER')"
       th:classappend="${page}=='tasks-manager' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M12 6a3 3 0 1 1 3 3" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Manager Tasks</span>
    </a>
    <a class="sb-link" th:href="@{/tasks/director}" sec:authorize="hasRole('IT_DIRECTOR')"
       th:classappend="${page}=='tasks-director' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M12 6a3 3 0 1 1 3 3" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>All Tasks</span>
    </a>
    <a class="sb-link" th:href="@{/change-requests}"
       th:classappend="${page}=='changes' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M4 4h10v6H4M4 14h16v6H4" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Change Requests</span>
    </a>

    <a class="sb-link" th:href="@{/users}"
       th:classappend="${page}=='users' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M8 11a4 4 0 1 0-4-4" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Users</span>
    </a>

    <a class="sb-link" th:href="@{/profile}"
       th:classappend="${page}=='profile' ? ' active' : ''">
      <svg class="i" viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
      <span>Profile</span>
    </a>
  </aside>

  <div class="main-content">
    <header>
      <h1>Task List</h1>
      <button id="sidebarToggle">☰</button>
    </header>
    <div class="alerts">
      <div th:if="${message}" class="alert alert--success" role="status" aria-live="polite">
        <svg viewBox="0 0 24 24" class="alert__icon"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm-1 11.732 5.196-5.196 1.414 1.414L11 16.268 6.39 11.657l1.414-1.414L11 13.904z" fill="currentColor"/></svg>
        <span th:text="${message}">Success</span>
        <button type="button" class="alert__close" onclick="this.parentNode.remove()" aria-label="Dismiss">×</button>
      </div>

      <div th:if="${error}" class="alert alert--error" role="alert" aria-live="assertive">
        <svg viewBox="0 0 24 24" class="alert__icon"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 13H11v2h2v-2Zm0-8h-2v6h2V7Z" fill="currentColor"/></svg>
        <span th:text="${error}">Something went wrong</span>
        <button type="button" class="alert__close" onclick="this.parentNode.remove()" aria-label="Dismiss">×</button>
      </div>
    </div>
    <!-- Filters Section -->
    <form method="get" th:action="@{/tasks/director}">
      <div class="filters">
        <label for="status">Status:</label>
        <select id="status" name="status">
          <option value="">All</option>
          <option value="TODO" th:selected="${filterStatus == 'TODO'}">Open</option>
          <option value="IN_PROGRESS" th:selected="${filterStatus == 'IN_PROGRESS'}">In Progress</option>
          <option value="COMPLETED" th:selected="${filterStatus == 'CLOSED'}">Closed</option>
        </select>

        <label for="requestType">Request Type:</label>
        <select id="requestType" name="requestType">
          <option value="">All</option>
          <option value="INFRA" th:selected="${filterRequestType == 'INFRA'}">Infra</option>
          <option value="PROD_APPS" th:selected="${filterRequestType == 'PROD_APPS'}">Prod Apps</option>
          <option value="BUSINESS_APPS" th:selected="${filterRequestType == 'BUSINESS_APPS'}">Business Apps</option>
        </select>

        <label for="assignedUser">Assigned User:</label>
        <select id="assignedUser" name="assignedUser">
          <option value="">All</option>
          <option th:each="user : ${users}" th:value="${user.id}" th:text="${user.firstName + ' ' + user.lastName}" th:selected="${filterAssignedUser == user.id}"></option>
        </select>

        <button type="submit" class="btn">Filter</button>
      </div>
    </form>

    <!-- Button to create a new task -->
    <a href="/tasks/new" class="btn">Create New Task</a>

    <!-- Task table to display all tasks -->
    <table class="task-table">
      <thead>
      <tr>
        <th>Title</th>
        <th>Status</th>
        <th>Due Date</th>
        <th>Assigned User</th>
        <th>Requester</th>
        <th>Priority</th>
        <th>Request Type</th>

        <th>File</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <!-- Iterate through the tasks using Thymeleaf -->
      <tr th:each="task : ${tasks}">
        <td th:text="${task.title}">Task Title</td>
        <td th:text="${task.status}">Task Status</td>
        <td th:text="${task.dueDate != null ? task.dueDate.format(T(java.time.format.DateTimeFormatter).ofPattern('dd-MM-yyyy')) : 'No due date'}">Due Date</td>

        <td th:text="${task.assignedUser != null ? task.assignedUser.firstName + ' ' + task.assignedUser.lastName : ' No assigned user '}">Assigned User</td>
        <td th:text="${task.requester != null ? task.requester.firstName + ' ' + task.requester.lastName : ' No data '}">Requester</td> <!-- Display requester -->
        <td th:text="${task.priority != null ? task.priority : ' No data '}">Priority</td>
        <td th:text="${task.requestType}"></td>
        <td>
          <!-- If the task has an associated file, display the download link -->
          <a th:if="${task.fileName != null}"
             th:href="@{/tasks/file/{fileName}(fileName=${task.fileName})}"
             th:text="${task.fileName}">Download</a>

          <!-- If there is no file associated, display 'No files' -->
          <span th:if="${task.fileName == null}">No files</span>
        </td>
        <td>
          <a th:href="@{/tasks/{id}(id=${task.id})}">View</a> |
          <a th:href="@{/tasks/edit/{id}(id=${task.id})}">Edit</a>
          <a th:href="@{/tasks/delete/{id}(id=${task.id})}" onclick="return confirm('Are you sure you want to delete this task?');">Delete</a>
        </td>
      </tr>
      <!-- Display a message if there are no tasks -->
      <tr th:if="${tasks.size() == 0}">
        <td colspan="5">No tasks found</td>
      </tr>
      </tbody>
    </table>
  </div>
</div>
</body>
<script>
  (function(){
    const sb = document.getElementById('appSidebar');
    const btn = document.getElementById('sidebarToggle');

    // Persist state across navigations (optional)
    const key = 'sidebar.collapsed';
    if (localStorage.getItem(key) === '1') sb.classList.add('is-collapsed');

    btn?.addEventListener('click', function(){
      sb.classList.toggle('is-collapsed');
      localStorage.setItem(key, sb.classList.contains('is-collapsed') ? '1' : '0');
    });

    // On small screens you might prefer hiding instead of collapsing:
    // toggle 'is-hidden' class instead if you like.
  })();
</script>
</html>
